name: Build MINI FIRE APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.8
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git unzip openjdk-11-jdk \
          python3-pip autoconf libtool \
          pkg-config zlib1g-dev \
          libncurses5-dev libncursesw5-dev \
          libtinfo5 cmake libffi-dev libssl-dev \
          ninja-build
          
    - name: Install Buildozer
      run: pip install buildozer
      
    - name: Initialize Buildozer
      run: |
        buildozer init
        # Use simple spec to avoid issues
        cat > buildozer.spec << EOF
[app]
title = MINI FIRE
package.name = minifire
package.domain = com.samiul
source.dir = .
source.include_exts = py,png,jpg,kv
version = 1.0.0
requirements = python3,kivy

[android]
api = 21
minapi = 21
permissions = INTERNET

[buildozer]
log_level = 2
EOF
        
    - name: Build APK
      run: |
        buildozer android debug 2>&1 | tail -100
        ls -la bin/ || echo "No bin directory"
        
    - name: Check for APK
      id: check-apk
      run: |
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "APK exists"
          echo "apk_exists=true" >> $GITHUB_OUTPUT
        else
          echo "APK not found"
          echo "apk_exists=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Upload APK
      if: steps.check-apk.outputs.apk_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: MINI-FIRE-APK
        path: bin/*.apk
        retention-days: 30
        
    - name: Upload build logs
      if: steps.check-apk.outputs.apk_exists == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          .buildozer/
          buildozer.spec
        retention-days: 5
